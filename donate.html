import base64
import hashlib
import json
from flask import Flask, request, jsonify
from mcrcon import MCRcon

app = Flask(__name__)

# üîë LiqPay –∫–ª—é—á—ñ (–∑ –æ—Å–æ–±–∏—Å—Ç–æ–≥–æ –∫–∞–±—ñ–Ω–µ—Ç—É LiqPay)
LIQPAY_PUBLIC = "sandbox_i28524890692"
LIQPAY_PRIVATE = "sandbox_N1zqYl44YbkLIpj73bEujO3kYSpdDiwMooSpyLAZ"

# üéÆ RCON –¥–∞–Ω—ñ
RCON_HOST = "server228.zapto.org"
RCON_PORT = 25575
RCON_PASSWORD = "Vlad20137777bo208goasfjmJkhgJn"

# üéÅ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–æ–Ω–∞—Ç-—Ä–∞–Ω–≥—ñ–≤
DONATE_PACKAGES = {
    50: "BADBOY",      # 50 –≥—Ä–Ω ‚Üí BADBOY
    100: "VIP",        # 100 –≥—Ä–Ω ‚Üí VIP
    250: "LEGEND",     # 250 –≥—Ä–Ω ‚Üí LEGEND
    500: "OVERLORD"    # 500 –≥—Ä–Ω ‚Üí OVERLORD
}


def liqpay_sign(data: str) -> str:
    """–°—Ç–≤–æ—Ä—é—î –ø—ñ–¥–ø–∏—Å –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ callback –≤—ñ–¥ LiqPay"""
    return base64.b64encode(
        hashlib.sha1((LIQPAY_PRIVATE + data + LIQPAY_PRIVATE).encode()).digest()
    ).decode()


@app.route("/donate", methods=["POST"])
def donate():
    """–û–±—Ä–æ–±–∫–∞ callback –≤—ñ–¥ LiqPay"""
    data = request.form.get("data")
    signature = request.form.get("signature")

    if not data or not signature:
        return jsonify({"error": "no data"}), 400

    # –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–ø–∏—Å—É
    if signature != liqpay_sign(data):
        return jsonify({"error": "bad signature"}), 400

    # —Ä–æ–∑–ø–∞–∫–æ–≤—É—î–º–æ JSON –≤—ñ–¥ LiqPay
    decoded = json.loads(base64.b64decode(data).decode())
    print("üì© LiqPay callback:", decoded)

    status = decoded.get("status")
    amount = int(float(decoded.get("amount", 0)))
    nickname = decoded.get("info")  # –∑ `info` –ø–µ—Ä–µ–¥–∞—î–º–æ –Ω—ñ–∫–Ω–µ–π–º

    if status == "success":
        rank = DONATE_PACKAGES.get(amount)

        if not rank:
            return jsonify({"error": f"No rank for {amount} UAH"}), 400

        try:
            # –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Minecraft —á–µ—Ä–µ–∑ RCON
            with MCRcon(RCON_HOST, RCON_PASSWORD, port=RCON_PORT) as mcr:
                command = f"lp user {nickname} parent set {rank}"
                resp = mcr.command(command)
                print(f"‚úÖ –í–∏–¥–∞–Ω–æ {rank} –≥—Ä–∞–≤—Ü—é {nickname}: {resp}")

            return jsonify({"status": "success", "nickname": nickname, "rank": rank})

        except Exception as e:
            print("‚ùå RCON error:", str(e))
            return jsonify({"error": "RCON error", "details": str(e)}), 500

    return jsonify({"status": "not paid"}), 200


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=True)
